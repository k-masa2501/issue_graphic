<%= javascript_include_tag "d3.v3.min", :plugin => "issue_graphic" %>
<%= javascript_include_tag "jquery-3.1.0.min", :plugin => "issue_graphic" %>
<%= stylesheet_link_tag "index", :plugin => "issue_graphic" %>
<%= javascript_include_tag "draw_chart", :plugin => "issue_graphic" %>
<h2><%= t('.view_h2') %></h2>
<div style="float: left;width: 100%">
  <div class="sum_img"></div>
  <div style="float: left;margin-left: 5px">
    <% @total_by_assigned.each do |v| %>
        <span style="margin-left: 5px"><%= v[0] == nil ? t('.not_assigned') : v[0]  %>:<%= v[1] %></span>
    <% end %>
  </div>
  <div style="float: left;margin-left: 5px">
    <div class="progress_img"></div>
    <% @progress.each do |v| %>
        <span style="margin-left: 5px"><%= v[0] == nil ? t('.not_assigned') : v[0] %>:<%= v[1] %></span>
    <% end %>

  </div>
</div>
<%= render partial: "issue_graphics/index_t/filter", locals: {params: params,
                                                            assigned_to: @assigned_to,
                                                            tracker: @tracker,
                                                            priority: @priority,
                                                            category: @category,
                                                            status: @status,
                                                            custom: @custom}  %>

<svg id="MyGraph" class="svg_main"></svg>
<div class="autoscroll">
  <table class="list issues sort-by-assigned-to sort-asc" style="margin-top: 10px">
    <thead>
    <tr>
      <th><%= t('.date') %></th>
      <th><%= t('.estimated') %></th>
      <th><%= t('.actual') %></th>
      <th><%= t('.gap') %></th>
      <% @member.each_with_index do |v, i| %>
         <th><%= v[0] == nil ? t('.not_assigned') : v[0] %></th>
      <% end %>
    </tr>
    </thead>
    <tbody>
    <% if @atual.present?  %>
        <% @atual.each_with_index.reverse_each do |value,index| %>
            <tr class="hascontextmenu <%= 0 == (index % 2) ? 'even' : 'odd' %> issue pulldown" data-process='0'>
              <% estimated = (@estimated[index][:value] - @plan[index][:value]).round(1) %>
              <% atual = (@estimated[index][:value] - value[:value]).round(1) %>
              <% daily_gap = @daily_gap[index].round(1) %>
              <% date = value[:date].strftime("%Y-%m-%d") %>
              <td data-date="<%= date %>"><%= date + @day_names[value[:date].wday] %></td>
              <td class="<%= get_num_color(estimated)  %>"><%= estimated %></td>
              <td class="<%= get_num_color(daily_gap) %>"><%= atual %></td>
              <td class="<%= get_num_color(daily_gap) %>"><%= daily_gap %></td>
              <% @member.each do |v| %>
                  <% logger.debug(@member) %>
                  <% logger.debug(@daily_sum) %>
                  <% item = @daily_sum[index].find {|item| item[:name] == v[0] } %>
                  <% nil != item ? sum = item[:sum].round(1) : sum = 0.0 %>
                  <td class="<%= get_n_color_of_assignend(sum) %>"><%= sum %></td>
              <% end %>
            </tr>
        <% end %>
    <% end %>
    </tbody>
  </table>
</div>
<script>
    var g_dSet1 = <%== @estimated.to_json %>;
    var g_dSet2 = <%== @atual.to_json %>;
    var g_dSet3 = <%== @plan.to_json %>;
    draw_d3_line_graph(g_dSet1,g_dSet2,g_dSet3);
</script>
<%= javascript_include_tag "index", :plugin => "issue_graphic" %>
